<!DOCTYPE html>
<html lang="EN">
<head>
    <title>Chat</title>
    <style>
        body { margin: 0; padding-bottom: 3rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        #form { background: rgba(0, 0, 0, 0.15); padding: 0.25rem; position: fixed; bottom: 0; left: 0; right: 0; display: flex; height: 3rem; box-sizing: border-box; backdrop-filter: blur(10px); }
        #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
        #input:focus { outline: none; }
        #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }

        #messages { list-style-type: none; margin: 0; padding: 0; }
        #messages > li { padding: 0.5rem 1rem; }
        #messages > li:nth-child(odd) { background: #efefef; }

        .message-time { color: #434651;}
    </style>
</head>
<body>
<table style="width:100%">
    <tr>
        <th style="width:80%">chat messages</th>
        <th>Users:</th>
    </tr>
    <tr>
        <td>
            <ul id="messages"></ul>
        </td>
        <td style="vertical-align:top">
            <ul id="usernames"></ul>
        </td>
    </tr>
</table>
<form id="form" action="">
    <input id="input" autocomplete="off" />
    <button>Send</button>
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io();
    //HTML parameters
    var messages = document.getElementById('messages');
    var usernames = document.getElementById('usernames');
    var form = document.getElementById('form');
    var input = document.getElementById('input');

    //Socket parameters
    var url = window.location.search;
    var urlParams = new URLSearchParams(url);
    var username;

    //If we have the get parameter user with the value taken
    if(urlParams.get("user") === "taken"){
        //Display the popup and ask to enter a new username
        popup = prompt("Username already taken, please enter another username:", "");
    }
    else{
        //If we don't have this parameter we display the basic popup
        popup = prompt("Enter a username:", "");
    }
    //If the popup is empty the username will be "Anonymous user"
    if (popup === '') {
        username = "Anonymous user";
    } else {
        username = popup;
    }

    //Call the server functions 'user connected' with the username and socket id, and 'new username' to update the user list
    socket.emit('user connected', {user:username , id:socket.id});
    socket.emit('new username', username);

    //Verify if a message is sent and call the function 'chat message'
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (input.value) {
            socket.emit('chat message', input.value);
            input.value = '';
        }
    });

    //Display the message in the chat with the username and the time
    socket.on('chat message', function(data) {
        var date = new Date();
        var hour = date.getHours();
        var minute = date.getMinutes();
        var seconds = date.getSeconds();
        var fullTime = hour +':'+ minute +':'+ seconds;

        var item = document.createElement('li');

        item.innerHTML = "<div>\n" +
            "            <span class=\"message-time\">" + fullTime + " by " + data.user + "</span>\n" +
            "        </div>\n" +
            "        <div>" + data.msg + "</div>";
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    //Display a message when a user disconnected
    socket.on('user disconnected', function(msg) {
        var item = document.createElement('li');
        item.textContent = msg;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    //Display a message when a new user is connected
    socket.on('user connected', function(msg) {
        var item = document.createElement('li');
        item.textContent = msg;
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
    });

    //Refresh the user list
    socket.on('new username', function(msg) {
        usernames.innerHTML = "";
        msg.forEach((element)=>{
            var item = document.createElement('li');
            item.textContent = element;
            usernames.appendChild(item);
        });
    });

    //Reload the page with the parameters user=taken
    socket.on('username taken', function() {
        window.location.href = "?user=taken";
    });
</script>
</body>
</html>